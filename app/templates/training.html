{% extends "layout.html" %}
{% block content %}
<h2>Training</h2>

{% if project %}
<h3>{{ project.name }}</h3>

<div class="accordion-container">
    <!-- Auto Train Section -->
    <div class="accordion-section" id="auto-train-section">
        <div class="accordion-header active" data-section="auto-train">
            <span class="accordion-title">Auto Train</span>
            <span class="accordion-meta">
                <span class="completion-status">Completion: <span id="completion-pct">0</span>%</span>
            </span>
            <span class="accordion-arrow">&#9660;</span>
        </div>
        <div class="accordion-content" id="auto-train-content">
            <div class="auto-train-controls">
                {% set has_data = stats.files.total > 0 or stats.lines.total > 0 or stats.tables.total > 0 or stats.rows.total > 0 %}
                <button type="button" id="auto-train-btn" class="auto-train-btn" {% if not has_data %}disabled{% endif %}>Auto Train</button>
            </div>

            <div class="training-progress">
                <div class="progress-grid">
                    <div class="progress-card">
                        <h4>Files</h4>
                        <div class="progress-stats">
                            <div class="stat-row">
                                <span class="stat-label">Total:</span>
                                <span class="stat-value" id="files-total">{{ stats.files.total }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Binary:</span>
                                <span class="stat-value" id="files-binary">{{ stats.files.binary }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Code:</span>
                                <span class="stat-value" id="files-code">{{ stats.files.code }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Valid:</span>
                                <span class="stat-value" id="files-valid">{{ stats.files.valid }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Mixed:</span>
                                <span class="stat-value" id="files-mixed">{{ stats.files.mixed }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Research:</span>
                                <span class="stat-value" id="files-research">{{ stats.files.research }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="progress-card">
                        <h4>Lines of Code</h4>
                        <div class="progress-stats">
                            <div class="stat-row">
                                <span class="stat-label">Total:</span>
                                <span class="stat-value" id="lines-total">{{ stats.lines.total }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Binary:</span>
                                <span class="stat-value" id="lines-binary">{{ stats.lines.binary }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Code:</span>
                                <span class="stat-value" id="lines-code">{{ stats.lines.code }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Valid:</span>
                                <span class="stat-value" id="lines-valid">{{ stats.lines.valid }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Mixed:</span>
                                <span class="stat-value" id="lines-mixed">{{ stats.lines.mixed }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Research:</span>
                                <span class="stat-value" id="lines-research">{{ stats.lines.research }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="progress-card">
                        <h4>Database Tables</h4>
                        <div class="progress-stats">
                            <div class="stat-row">
                                <span class="stat-label">Total:</span>
                                <span class="stat-value" id="tables-total">{{ stats.tables.total }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Binary:</span>
                                <span class="stat-value" id="tables-binary">{{ stats.tables.binary }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Data:</span>
                                <span class="stat-value" id="tables-data">{{ stats.tables.data }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Valid:</span>
                                <span class="stat-value" id="tables-valid">{{ stats.tables.valid }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Mixed:</span>
                                <span class="stat-value" id="tables-mixed">{{ stats.tables.mixed }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Research:</span>
                                <span class="stat-value" id="tables-research">{{ stats.tables.research }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="progress-card">
                        <h4>Database Rows</h4>
                        <div class="progress-stats">
                            <div class="stat-row">
                                <span class="stat-label">Total:</span>
                                <span class="stat-value" id="rows-total">{{ stats.rows.total }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Binary:</span>
                                <span class="stat-value" id="rows-binary">{{ stats.rows.binary }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Data:</span>
                                <span class="stat-value" id="rows-data">{{ stats.rows.data }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Valid:</span>
                                <span class="stat-value" id="rows-valid">{{ stats.rows.valid }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Mixed:</span>
                                <span class="stat-value" id="rows-mixed">{{ stats.rows.mixed }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Research:</span>
                                <span class="stat-value" id="rows-research">{{ stats.rows.research }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Train Section -->
    <div class="accordion-section" id="manual-train-section">
        <div class="accordion-header" data-section="manual-train">
            <span class="accordion-title">Manual Train</span>
            <span class="accordion-arrow">&#9654;</span>
        </div>
        <div class="accordion-content collapsed" id="manual-train-content">
            <form action="/training" method="get" class="manual-train-form">
                <input type="hidden" name="project_id" value="{{ project.id }}">
                <label>Data Type:
                    <select name="data_type" onchange="this.form.submit()">
                        {% for dt in data_types %}
                        <option value="{{ dt.value }}" {% if selected_data_type == dt.value %}selected{% endif %}>{{ dt.label }}</option>
                        {% endfor %}
                    </select>
                </label>
            </form>
            <div class="manual-train-placeholder">
                <p>Manual training interface coming soon...</p>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var projectId = '{{ project.id }}';
    var btn = document.getElementById('auto-train-btn');
    var completionPct = document.getElementById('completion-pct');
    var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    var jobType = 'auto_train_' + projectId;

    // Accordion functionality
    var headers = document.querySelectorAll('.accordion-header');
    headers.forEach(function(header) {
        header.addEventListener('click', function() {
            var section = this.getAttribute('data-section');
            var content = document.getElementById(section + '-content');
            var isActive = this.classList.contains('active');

            // Close all sections
            headers.forEach(function(h) {
                h.classList.remove('active');
                h.querySelector('.accordion-arrow').innerHTML = '&#9654;';
            });
            document.querySelectorAll('.accordion-content').forEach(function(c) {
                c.classList.add('collapsed');
            });

            // Open clicked section if it wasn't already active
            if (!isActive) {
                this.classList.add('active');
                this.querySelector('.accordion-arrow').innerHTML = '&#9660;';
                content.classList.remove('collapsed');
            }
        });
    });

    function updateProgressFromData(data) {
        // Update files
        document.getElementById('files-total').textContent = data.files.total;
        document.getElementById('files-binary').textContent = data.files.binary;
        document.getElementById('files-code').textContent = data.files.code;
        document.getElementById('files-valid').textContent = data.files.valid;
        document.getElementById('files-mixed').textContent = data.files.mixed;
        document.getElementById('files-research').textContent = data.files.research;

        // Update lines
        document.getElementById('lines-total').textContent = data.lines.total;
        document.getElementById('lines-binary').textContent = data.lines.binary;
        document.getElementById('lines-code').textContent = data.lines.code;
        document.getElementById('lines-valid').textContent = data.lines.valid;
        document.getElementById('lines-mixed').textContent = data.lines.mixed;
        document.getElementById('lines-research').textContent = data.lines.research;

        // Update tables
        document.getElementById('tables-total').textContent = data.tables.total;
        document.getElementById('tables-binary').textContent = data.tables.binary;
        document.getElementById('tables-data').textContent = data.tables.data;
        document.getElementById('tables-valid').textContent = data.tables.valid;
        document.getElementById('tables-mixed').textContent = data.tables.mixed;
        document.getElementById('tables-research').textContent = data.tables.research;

        // Update rows
        document.getElementById('rows-total').textContent = data.rows.total;
        document.getElementById('rows-binary').textContent = data.rows.binary;
        document.getElementById('rows-data').textContent = data.rows.data;
        document.getElementById('rows-valid').textContent = data.rows.valid;
        document.getElementById('rows-mixed').textContent = data.rows.mixed;
        document.getElementById('rows-research').textContent = data.rows.research;
    }

    function observeJob(jobId) {
        var wsUrl = protocol + '//' + window.location.host + '/job/' + jobId + '/ws';
        var ws = new WebSocket(wsUrl);

        ws.onopen = function() {
            btn.disabled = true;
            btn.textContent = 'Training...';
        };

        ws.onmessage = function(event) {
            var msg = JSON.parse(event.data);

            if (msg.type === 'update') {
                // Update completion percentage
                completionPct.textContent = msg.progress || 0;

                // Parse progress data from message field
                if (msg.message) {
                    try {
                        var progressData = JSON.parse(msg.message);
                        if (progressData.data) {
                            updateProgressFromData(progressData.data);
                        }
                    } catch (e) {
                        // Message is not JSON, just show as status
                        btn.textContent = msg.message.length > 20 ? msg.message.substring(0, 20) + '...' : msg.message;
                    }
                }

            } else if (msg.type === 'done') {
                if (msg.status === 'completed') {
                    btn.textContent = 'Done!';
                    completionPct.textContent = '100';
                    setTimeout(function() {
                        btn.disabled = false;
                        btn.textContent = 'Auto Train';
                    }, 2000);
                } else if (msg.status === 'failed') {
                    alert('Error: ' + (msg.error_details || msg.message || 'Training failed'));
                    btn.disabled = false;
                    btn.textContent = 'Auto Train';
                } else if (msg.status === 'cancelled') {
                    btn.disabled = false;
                    btn.textContent = 'Auto Train';
                }

            } else if (msg.type === 'error') {
                alert('Error: ' + msg.message);
                btn.disabled = false;
                btn.textContent = 'Auto Train';
            }
        };

        ws.onerror = function() {
            // Fall back to polling
            pollJobStatus(jobId);
        };

        ws.onclose = function(event) {
            if (!event.wasClean && btn.disabled) {
                setTimeout(function() { checkAndReconnect(); }, 2000);
            }
        };
    }

    function pollJobStatus(jobId) {
        fetch('/job/' + jobId)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'running' || data.status === 'pending') {
                    completionPct.textContent = data.progress || 0;

                    // Parse progress data from message
                    if (data.message) {
                        try {
                            var progressData = JSON.parse(data.message);
                            if (progressData.data) {
                                updateProgressFromData(progressData.data);
                            }
                        } catch (e) {}
                    }

                    setTimeout(function() { pollJobStatus(jobId); }, 1000);
                } else if (data.status === 'completed') {
                    completionPct.textContent = '100';
                    btn.textContent = 'Done!';
                    setTimeout(function() {
                        btn.disabled = false;
                        btn.textContent = 'Auto Train';
                    }, 2000);
                } else {
                    btn.disabled = false;
                    btn.textContent = 'Auto Train';
                }
            })
            .catch(function() {
                btn.disabled = false;
                btn.textContent = 'Auto Train';
            });
    }

    function checkAndReconnect() {
        fetch('/project/' + projectId + '/job/' + jobType)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'running' || data.status === 'pending') {
                    // Only update UI if job was started within last 5 minutes
                    // This prevents stale jobs from overwriting current stats
                    var jobStart = new Date(data.started_at || data.created_at);
                    var now = new Date();
                    var ageMinutes = (now - jobStart) / 1000 / 60;

                    if (ageMinutes < 5) {
                        completionPct.textContent = data.progress || 0;
                        btn.disabled = true;
                        btn.textContent = 'Training...';
                        observeJob(data.id);
                    }
                    // If job is stale (>5 min old and still "running"), ignore it
                }
            })
            .catch(function() {});
    }

    btn.addEventListener('click', function() {
        if (!projectId) {
            alert('Please select a project first');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Starting...';

        fetch('/project/' + projectId + '/auto-train/start', {
            method: 'POST'
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                alert('Error: ' + data.error);
                btn.disabled = false;
                btn.textContent = 'Auto Train';
                return;
            }

            completionPct.textContent = '0';
            observeJob(data.job_id);
        })
        .catch(function(err) {
            alert('Error starting training: ' + err);
            btn.disabled = false;
            btn.textContent = 'Auto Train';
        });
    });

    // On page load, check for running jobs
    checkAndReconnect();
})();
</script>

{% else %}
<p>Select a project from the menu above to begin training.</p>
{% endif %}

{% endblock %}
