{% extends "layout.html" %}
{% block content %}
<h2>Training</h2>

<div class="training-controls">
    <div class="auto-train-group">
        {% set has_data = scan_totals.files > 0 or scan_totals.lines > 0 or scan_totals.tables > 0 or scan_totals.rows > 0 %}
        <button type="button" id="auto-train-btn" class="auto-train-btn" {% if not has_data %}disabled{% endif %}>Auto Train</button>
        <span class="completion-status">Completion %: <span id="completion-pct">0</span></span>
    </div>

    <div class="training-divider"></div>

    <form action="/training" method="get" class="training-selectors">
        <label>Select Project:
            <select name="project_id" onchange="this.form.submit()">
                <option value="">-- Choose a project --</option>
                {% for p in projects %}
                <option value="{{ p.id }}" {% if project and project.id == p.id %}selected{% endif %}>{{ p.name }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Data Type:
            <select name="data_type" onchange="this.form.submit()">
                {% for dt in data_types %}
                <option value="{{ dt.value }}" {% if selected_data_type == dt.value %}selected{% endif %}>{{ dt.label }}</option>
                {% endfor %}
            </select>
        </label>
    </form>
</div>

{% if project %}
<h3>{{ project.name }}</h3>

<div class="training-progress">
    <div class="progress-grid">
        <div class="progress-card">
            <h4>Files</h4>
            <div class="progress-stats">
                <div class="stat-row">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value" id="files-total">{{ scan_totals.files }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Processed:</span>
                    <span class="stat-value" id="files-processed">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Matched:</span>
                    <span class="stat-value" id="files-matched">0</span>
                </div>
            </div>
        </div>

        <div class="progress-card">
            <h4>Lines of Code</h4>
            <div class="progress-stats">
                <div class="stat-row">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value" id="lines-total">{{ scan_totals.lines }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Processed:</span>
                    <span class="stat-value" id="lines-processed">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Matched:</span>
                    <span class="stat-value" id="lines-matched">0</span>
                </div>
            </div>
        </div>

        <div class="progress-card">
            <h4>Database Tables</h4>
            <div class="progress-stats">
                <div class="stat-row">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value" id="tables-total">{{ scan_totals.tables }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Processed:</span>
                    <span class="stat-value" id="tables-processed">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Matched:</span>
                    <span class="stat-value" id="tables-matched">0</span>
                </div>
            </div>
        </div>

        <div class="progress-card">
            <h4>Database Rows</h4>
            <div class="progress-stats">
                <div class="stat-row">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value" id="rows-total">{{ scan_totals.rows }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Processed:</span>
                    <span class="stat-value" id="rows-processed">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Matched:</span>
                    <span class="stat-value" id="rows-matched">0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var projectId = '{{ project.id }}';
    var btn = document.getElementById('auto-train-btn');
    var completionPct = document.getElementById('completion-pct');
    var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    var jobType = 'auto_train_' + projectId;

    function updateProgressFromData(data) {
        // Update files
        document.getElementById('files-processed').textContent = data.files.processed;
        document.getElementById('files-matched').textContent = data.files.matched;

        // Update lines
        document.getElementById('lines-processed').textContent = data.lines.processed;
        document.getElementById('lines-matched').textContent = data.lines.matched;

        // Update tables
        document.getElementById('tables-processed').textContent = data.tables.processed;
        document.getElementById('tables-matched').textContent = data.tables.matched;

        // Update rows
        document.getElementById('rows-processed').textContent = data.rows.processed;
        document.getElementById('rows-matched').textContent = data.rows.matched;
    }

    function observeJob(jobId) {
        var wsUrl = protocol + '//' + window.location.host + '/job/' + jobId + '/ws';
        var ws = new WebSocket(wsUrl);

        ws.onopen = function() {
            btn.disabled = true;
            btn.textContent = 'Training...';
        };

        ws.onmessage = function(event) {
            var msg = JSON.parse(event.data);

            if (msg.type === 'update') {
                // Update completion percentage
                completionPct.textContent = msg.progress || 0;

                // Parse progress data from message field
                if (msg.message) {
                    try {
                        var progressData = JSON.parse(msg.message);
                        if (progressData.data) {
                            updateProgressFromData(progressData.data);
                        }
                    } catch (e) {
                        // Message is not JSON, just show as status
                        btn.textContent = msg.message.length > 20 ? msg.message.substring(0, 20) + '...' : msg.message;
                    }
                }

            } else if (msg.type === 'done') {
                if (msg.status === 'completed') {
                    btn.textContent = 'Done!';
                    completionPct.textContent = '100';
                    setTimeout(function() {
                        btn.disabled = false;
                        btn.textContent = 'Auto Train';
                    }, 2000);
                } else if (msg.status === 'failed') {
                    alert('Error: ' + (msg.error_details || msg.message || 'Training failed'));
                    btn.disabled = false;
                    btn.textContent = 'Auto Train';
                } else if (msg.status === 'cancelled') {
                    btn.disabled = false;
                    btn.textContent = 'Auto Train';
                }

            } else if (msg.type === 'error') {
                alert('Error: ' + msg.message);
                btn.disabled = false;
                btn.textContent = 'Auto Train';
            }
        };

        ws.onerror = function() {
            // Fall back to polling
            pollJobStatus(jobId);
        };

        ws.onclose = function(event) {
            if (!event.wasClean && btn.disabled) {
                setTimeout(function() { checkAndReconnect(); }, 2000);
            }
        };
    }

    function pollJobStatus(jobId) {
        fetch('/job/' + jobId)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'running' || data.status === 'pending') {
                    completionPct.textContent = data.progress || 0;

                    // Parse progress data from message
                    if (data.message) {
                        try {
                            var progressData = JSON.parse(data.message);
                            if (progressData.data) {
                                updateProgressFromData(progressData.data);
                            }
                        } catch (e) {}
                    }

                    setTimeout(function() { pollJobStatus(jobId); }, 1000);
                } else if (data.status === 'completed') {
                    completionPct.textContent = '100';
                    btn.textContent = 'Done!';
                    setTimeout(function() {
                        btn.disabled = false;
                        btn.textContent = 'Auto Train';
                    }, 2000);
                } else {
                    btn.disabled = false;
                    btn.textContent = 'Auto Train';
                }
            })
            .catch(function() {
                btn.disabled = false;
                btn.textContent = 'Auto Train';
            });
    }

    function checkAndReconnect() {
        fetch('/project/' + projectId + '/job/' + jobType)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'running' || data.status === 'pending') {
                    completionPct.textContent = data.progress || 0;

                    // Parse progress data from message
                    if (data.message) {
                        try {
                            var progressData = JSON.parse(data.message);
                            if (progressData.data) {
                                updateProgressFromData(progressData.data);
                            }
                        } catch (e) {}
                    }

                    observeJob(data.id);
                }
            })
            .catch(function() {});
    }

    btn.addEventListener('click', function() {
        if (!projectId) {
            alert('Please select a project first');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Starting...';

        fetch('/project/' + projectId + '/auto-train/start', {
            method: 'POST'
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                alert('Error: ' + data.error);
                btn.disabled = false;
                btn.textContent = 'Auto Train';
                return;
            }

            completionPct.textContent = '0';
            observeJob(data.job_id);
        })
        .catch(function(err) {
            alert('Error starting training: ' + err);
            btn.disabled = false;
            btn.textContent = 'Auto Train';
        });
    });

    // On page load, check for running jobs
    checkAndReconnect();
})();
</script>

{% elif projects %}
<p>Select a project to begin training.</p>
{% else %}
<p>No projects yet. <a href="/projects">Create one</a> to get started.</p>
{% endif %}

{% endblock %}
