{% extends "layout.html" %}
{% block content %}
<h2>Inventory {% if project %}<span id="ws-status" class="ws-status ws-checking" style="font-size: 12px; font-weight: normal;">checking...</span>{% endif %}</h2>

<form action="/inventory" method="get" class="project-selector">
    <label>Select Project:
        <select name="project_id" onchange="this.form.submit()">
            <option value="">-- Choose a project --</option>
            {% for p in projects %}
            <option value="{{ p.id }}" {% if project and project.id == p.id %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
        </select>
    </label>
</form>

{% if project %}
<h3>{{ project.name }}</h3>

<div class="stats-grid">
    <div class="stat-card">
        <h4>Files</h4>
        <div class="stat-number" id="file-count">{{ stats.files.total_files or 0 }}</div>
        <div class="stat-label">Total Files</div>
        <div class="stat-progress">
            <span class="processed">{{ stats.files.processed_files or 0 }}</span> / {{ stats.files.total_files or 0 }} processed
        </div>
        <div id="scan-progress" style="display: none; margin: 0.5rem 0; color: var(--accent);">
            <span id="scan-count">0</span> files found...
        </div>
        <form id="scan-files-form" action="/project/{{ project.id }}/scan/files" method="post" class="scan-form">
            <button type="submit" id="scan-btn" class="scan-btn">Scan Files</button>
        </form>
    </div>

    <div class="stat-card">
        <h4>Lines of Code</h4>
        <div class="stat-number" id="lines-count">{{ stats.file_rows.total_rows or 0 }}</div>
        <div class="stat-label">Total Lines</div>
        <div class="stat-progress">
            <span class="processed">{{ stats.file_rows.processed_rows or 0 }}</span> / {{ stats.file_rows.total_rows or 0 }} processed
        </div>
        <div id="scan-lines-progress" style="display: none; margin: 0.5rem 0; color: var(--accent);">
            <span id="scan-lines-count">0</span> lines found...
        </div>
        <form id="scan-lines-form" action="/project/{{ project.id }}/scan/lines" method="post" class="scan-form">
            <button type="submit" id="scan-lines-btn" class="scan-btn" {% if not stats.files.total_files %}disabled title="Scan files first" style="background: #4a5568; color: #718096; cursor: not-allowed;"{% endif %}>Scan Lines</button>
        </form>
    </div>

    <div class="stat-card">
        <h4>Database Tables</h4>
        <div class="stat-number">{{ stats.db_tables.total_tables or 0 }}</div>
        <div class="stat-label">Total Tables</div>
        <div class="stat-progress">
            <span class="processed">{{ stats.db_tables.processed_tables or 0 }}</span> / {{ stats.db_tables.total_tables or 0 }} processed
        </div>
    </div>

    <div class="stat-card">
        <h4>Database Rows</h4>
        <div class="stat-number">{{ stats.db_table_rows.total_rows or 0 }}</div>
        <div class="stat-label">Total Rows</div>
        <div class="stat-progress">
            <span class="processed">{{ stats.db_table_rows.processed_rows or 0 }}</span> / {{ stats.db_table_rows.total_rows or 0 }} processed
        </div>
    </div>
</div>

<div class="reset-section">
    <button type="button" id="reset-btn" class="reset-btn" onclick="resetDatabase()">Reset Files &amp; Lines</button>
</div>

{% elif projects %}
<p>Select a project to view its inventory.</p>
{% else %}
<p>No projects yet. <a href="/projects">Create one</a> to get started.</p>
{% endif %}

{% if project %}
<script>
(function checkWebSocket() {
    var statusEl = document.getElementById('ws-status');
    if (!statusEl) return;

    if (!window.WebSocket) {
        statusEl.textContent = 'websockets unavailable';
        statusEl.className = 'ws-status ws-unavailable';
        return;
    }

    var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    var wsUrl = protocol + '//' + window.location.host + '/ws/ping';
    var ws = new WebSocket(wsUrl);
    var timeout = setTimeout(function() {
        ws.close();
        statusEl.textContent = 'websockets unavailable';
        statusEl.className = 'ws-status ws-unavailable';
    }, 3000);

    ws.onopen = function() {
        clearTimeout(timeout);
        ws.close();
        statusEl.textContent = 'websockets enabled';
        statusEl.className = 'ws-status ws-enabled';
    };

    ws.onerror = function() {
        clearTimeout(timeout);
        statusEl.textContent = 'websockets unavailable';
        statusEl.className = 'ws-status ws-unavailable';
    };
})();

function resetDatabase() {
    if (!confirm('Are you sure you want to reset all files and lines data? This cannot be undone.')) {
        return;
    }

    var btn = document.getElementById('reset-btn');
    btn.disabled = true;
    btn.textContent = 'Resetting...';

    fetch('/project/{{ project.id }}/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            btn.textContent = 'Reset Complete!';
            setTimeout(function() { window.location.reload(); }, 1000);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.textContent = 'Reset Files & Lines';
        }
    })
    .catch(function(err) {
        alert('Error: ' + err);
        btn.disabled = false;
        btn.textContent = 'Reset Files & Lines';
    });
}

(function() {
    var projectId = '{{ project.id }}';
    var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';

    // Scan Files WebSocket
    var filesForm = document.getElementById('scan-files-form');
    var filesBtn = document.getElementById('scan-btn');
    var filesProgress = document.getElementById('scan-progress');
    var filesCountSpan = document.getElementById('scan-count');
    var fileCount = document.getElementById('file-count');

    if (filesForm && window.WebSocket) {
        filesForm.addEventListener('submit', function(e) {
            e.preventDefault();

            var wsUrl = protocol + '//' + window.location.host + '/project/' + projectId + '/scan/files/ws';
            var ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                filesBtn.disabled = true;
                filesBtn.textContent = 'Scanning...';
                filesProgress.style.display = 'block';
                filesCountSpan.textContent = '0';
                fileCount.textContent = '0';
            };

            ws.onmessage = function(event) {
                var data = JSON.parse(event.data);

                if (data.type === 'progress') {
                    filesCountSpan.textContent = data.count;
                    fileCount.textContent = data.count;
                } else if (data.type === 'done') {
                    filesCountSpan.textContent = data.total;
                    fileCount.textContent = data.total;
                    filesBtn.textContent = 'Done!';
                    setTimeout(function() {
                        window.location.reload();
                    }, 1000);
                } else if (data.type === 'error') {
                    alert('Error: ' + data.message);
                    filesBtn.disabled = false;
                    filesBtn.textContent = 'Scan Files';
                    filesProgress.style.display = 'none';
                }
            };

            ws.onerror = function() {
                filesForm.submit();
            };
        });
    }

    // Scan Lines WebSocket
    var linesForm = document.getElementById('scan-lines-form');
    var linesBtn = document.getElementById('scan-lines-btn');
    var linesProgress = document.getElementById('scan-lines-progress');
    var linesCountSpan = document.getElementById('scan-lines-count');
    var linesCount = document.getElementById('lines-count');

    if (linesForm && window.WebSocket) {
        linesForm.addEventListener('submit', function(e) {
            e.preventDefault();

            var wsUrl = protocol + '//' + window.location.host + '/project/' + projectId + '/scan/lines/ws';
            var ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                linesBtn.disabled = true;
                linesBtn.textContent = 'Scanning...';
                linesProgress.style.display = 'block';
                linesCountSpan.textContent = '0';
                linesCount.textContent = '0';
            };

            ws.onmessage = function(event) {
                var data = JSON.parse(event.data);

                if (data.type === 'progress') {
                    linesCountSpan.textContent = data.count;
                    linesCount.textContent = data.count;
                } else if (data.type === 'done') {
                    linesCountSpan.textContent = data.total;
                    linesCount.textContent = data.total;
                    linesBtn.textContent = 'Done!';
                    setTimeout(function() {
                        window.location.reload();
                    }, 1000);
                } else if (data.type === 'error') {
                    alert('Error: ' + data.message);
                    linesBtn.disabled = false;
                    linesBtn.textContent = 'Scan Lines';
                    linesProgress.style.display = 'none';
                }
            };

            ws.onerror = function() {
                linesForm.submit();
            };
        });
    }
})();
</script>
{% endif %}
{% endblock %}
