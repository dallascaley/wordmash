{% extends "layout.html" %}
{% block content %}
<h2>Inventory {% if project %}<span id="ws-status" class="ws-status ws-checking" style="font-size: 12px; font-weight: normal;">checking...</span>{% endif %}</h2>

<form action="/inventory" method="get" class="project-selector">
    <label>Select Project:
        <select name="project_id" onchange="this.form.submit()">
            <option value="">-- Choose a project --</option>
            {% for p in projects %}
            <option value="{{ p.id }}" {% if project and project.id == p.id %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
        </select>
    </label>
</form>

{% if project %}
<h3>{{ project.name }}</h3>

<h4 class="section-title">Clean</h4>
<div class="stats-grid">
    <div class="stat-card">
        <h4>Files</h4>
        <div class="stat-number" id="clean-file-count">{{ clean_stats.files.total_files or 0 }}</div>
        <div class="stat-label">Total Files</div>
        <div class="stat-progress">
            <span class="processed">{{ clean_stats.files.processed_files or 0 }}</span> / {{ clean_stats.files.total_files or 0 }} processed
        </div>
        <div id="clean-scan-progress" style="display: none; margin: 0.5rem 0; color: var(--accent);">
            <span id="clean-scan-count">0</span> files found...
        </div>
        <form id="clean-scan-files-form" action="/project/{{ project.id }}/scan/files?is_dirty=0" method="post" class="scan-form">
            <button type="submit" id="clean-scan-btn" class="scan-btn">Scan Files</button>
        </form>
    </div>

    <div class="stat-card">
        <h4>Lines of Code</h4>
        <div class="stat-number" id="clean-lines-count">{{ clean_stats.file_rows.total_rows or 0 }}</div>
        <div class="stat-label">Total Lines</div>
        <div class="stat-progress">
            <span class="processed">{{ clean_stats.file_rows.processed_rows or 0 }}</span> / {{ clean_stats.file_rows.total_rows or 0 }} processed
        </div>
        <div id="clean-scan-lines-progress" style="display: none; margin: 0.5rem 0; color: var(--accent);">
            <span id="clean-scan-lines-count">0</span> lines found...
        </div>
        <form id="clean-scan-lines-form" action="/project/{{ project.id }}/scan/lines?is_dirty=0" method="post" class="scan-form">
            <button type="submit" id="clean-scan-lines-btn" class="scan-btn" {% if not clean_stats.files.total_files %}disabled title="Scan files first" style="background: #4a5568; color: #718096; cursor: not-allowed;"{% endif %}>Scan Lines</button>
        </form>
    </div>

    <div class="stat-card">
        <h4>Database Tables</h4>
        <div class="stat-number" id="clean-tables-count">{{ clean_stats.db_tables.total_tables or 0 }}</div>
        <div class="stat-label">Total Tables</div>
        <div class="stat-progress">
            <span class="processed">{{ clean_stats.db_tables.processed_tables or 0 }}</span> / {{ clean_stats.db_tables.total_tables or 0 }} processed
        </div>
        <div id="clean-scan-tables-progress" style="display: none; margin: 0.5rem 0; color: var(--accent);">
            <span id="clean-scan-tables-count">0</span> tables found...
        </div>
        <form id="clean-scan-tables-form" action="/project/{{ project.id }}/scan/tables?is_dirty=0" method="post" class="scan-form">
            <button type="submit" id="clean-scan-tables-btn" class="scan-btn" {% if not project.clean_db %}disabled title="Set Clean DB in project settings first" style="background: #4a5568; color: #718096; cursor: not-allowed;"{% endif %}>Scan Tables</button>
        </form>
    </div>

    <div class="stat-card">
        <h4>Database Rows</h4>
        <div class="stat-number" id="clean-db-rows-count">{{ clean_stats.db_table_rows.total_rows or 0 }}</div>
        <div class="stat-label">Total Rows</div>
        <div class="stat-progress">
            <span class="processed">{{ clean_stats.db_table_rows.processed_rows or 0 }}</span> / {{ clean_stats.db_table_rows.total_rows or 0 }} processed
        </div>
        <div id="clean-scan-db-rows-progress" style="display: none; margin: 0.5rem 0; color: var(--accent);">
            <span id="clean-scan-db-rows-count">0</span> rows found...
        </div>
        <form id="clean-scan-db-rows-form" action="/project/{{ project.id }}/scan/db-rows?is_dirty=0" method="post" class="scan-form">
            <button type="submit" id="clean-scan-db-rows-btn" class="scan-btn" {% if not clean_stats.db_tables.total_tables %}disabled title="Scan tables first" style="background: #4a5568; color: #718096; cursor: not-allowed;"{% endif %}>Scan Rows</button>
        </form>
    </div>
</div>

<h4 class="section-title">Dirty</h4>
<div class="stats-grid">
    <div class="stat-card">
        <h4>Files</h4>
        <div class="stat-number" id="dirty-file-count">{{ dirty_stats.files.total_files or 0 }}</div>
        <div class="stat-label">Total Files</div>
        <div class="stat-progress">
            <span class="processed">{{ dirty_stats.files.processed_files or 0 }}</span> / {{ dirty_stats.files.total_files or 0 }} processed
        </div>
        <div id="dirty-scan-progress" style="display: none; margin: 0.5rem 0; color: var(--accent);">
            <span id="dirty-scan-count">0</span> files found...
        </div>
        <form id="dirty-scan-files-form" action="/project/{{ project.id }}/scan/files?is_dirty=1" method="post" class="scan-form">
            <button type="submit" id="dirty-scan-btn" class="scan-btn">Scan Files</button>
        </form>
    </div>

    <div class="stat-card">
        <h4>Lines of Code</h4>
        <div class="stat-number" id="dirty-lines-count">{{ dirty_stats.file_rows.total_rows or 0 }}</div>
        <div class="stat-label">Total Lines</div>
        <div class="stat-progress">
            <span class="processed">{{ dirty_stats.file_rows.processed_rows or 0 }}</span> / {{ dirty_stats.file_rows.total_rows or 0 }} processed
        </div>
        <div id="dirty-scan-lines-progress" style="display: none; margin: 0.5rem 0; color: var(--accent);">
            <span id="dirty-scan-lines-count">0</span> lines found...
        </div>
        <form id="dirty-scan-lines-form" action="/project/{{ project.id }}/scan/lines?is_dirty=1" method="post" class="scan-form">
            <button type="submit" id="dirty-scan-lines-btn" class="scan-btn" {% if not dirty_stats.files.total_files %}disabled title="Scan files first" style="background: #4a5568; color: #718096; cursor: not-allowed;"{% endif %}>Scan Lines</button>
        </form>
    </div>

    <div class="stat-card">
        <h4>Database Tables</h4>
        <div class="stat-number" id="dirty-tables-count">{{ dirty_stats.db_tables.total_tables or 0 }}</div>
        <div class="stat-label">Total Tables</div>
        <div class="stat-progress">
            <span class="processed">{{ dirty_stats.db_tables.processed_tables or 0 }}</span> / {{ dirty_stats.db_tables.total_tables or 0 }} processed
        </div>
        <div id="dirty-scan-tables-progress" style="display: none; margin: 0.5rem 0; color: var(--accent);">
            <span id="dirty-scan-tables-count">0</span> tables found...
        </div>
        <form id="dirty-scan-tables-form" action="/project/{{ project.id }}/scan/tables?is_dirty=1" method="post" class="scan-form">
            <button type="submit" id="dirty-scan-tables-btn" class="scan-btn" {% if not project.dirty_db %}disabled title="Set Dirty DB in project settings first" style="background: #4a5568; color: #718096; cursor: not-allowed;"{% endif %}>Scan Tables</button>
        </form>
    </div>

    <div class="stat-card">
        <h4>Database Rows</h4>
        <div class="stat-number" id="dirty-db-rows-count">{{ dirty_stats.db_table_rows.total_rows or 0 }}</div>
        <div class="stat-label">Total Rows</div>
        <div class="stat-progress">
            <span class="processed">{{ dirty_stats.db_table_rows.processed_rows or 0 }}</span> / {{ dirty_stats.db_table_rows.total_rows or 0 }} processed
        </div>
        <div id="dirty-scan-db-rows-progress" style="display: none; margin: 0.5rem 0; color: var(--accent);">
            <span id="dirty-scan-db-rows-count">0</span> rows found...
        </div>
        <form id="dirty-scan-db-rows-form" action="/project/{{ project.id }}/scan/db-rows?is_dirty=1" method="post" class="scan-form">
            <button type="submit" id="dirty-scan-db-rows-btn" class="scan-btn" {% if not dirty_stats.db_tables.total_tables %}disabled title="Scan tables first" style="background: #4a5568; color: #718096; cursor: not-allowed;"{% endif %}>Scan Rows</button>
        </form>
    </div>
</div>

<div class="reset-section">
    <button type="button" id="reset-btn" class="reset-btn" onclick="resetDatabase()">Reset All Data</button>
</div>

{% elif projects %}
<p>Select a project to view its inventory.</p>
{% else %}
<p>No projects yet. <a href="/projects">Create one</a> to get started.</p>
{% endif %}

{% if project %}
<script>
(function checkWebSocket() {
    var statusEl = document.getElementById('ws-status');
    if (!statusEl) return;

    if (!window.WebSocket) {
        statusEl.textContent = 'websockets unavailable';
        statusEl.className = 'ws-status ws-unavailable';
        return;
    }

    var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    var wsUrl = protocol + '//' + window.location.host + '/ws/ping';
    var ws = new WebSocket(wsUrl);
    var timeout = setTimeout(function() {
        ws.close();
        statusEl.textContent = 'websockets unavailable';
        statusEl.className = 'ws-status ws-unavailable';
    }, 3000);

    ws.onopen = function() {
        clearTimeout(timeout);
        ws.close();
        statusEl.textContent = 'websockets enabled';
        statusEl.className = 'ws-status ws-enabled';
    };

    ws.onerror = function() {
        clearTimeout(timeout);
        statusEl.textContent = 'websockets unavailable';
        statusEl.className = 'ws-status ws-unavailable';
    };
})();

function resetDatabase() {
    if (!confirm('Are you sure you want to reset all files and lines data? This cannot be undone.')) {
        return;
    }

    var btn = document.getElementById('reset-btn');
    btn.disabled = true;
    btn.textContent = 'Resetting...';

    fetch('/project/{{ project.id }}/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            btn.textContent = 'Reset Complete!';
            setTimeout(function() { window.location.reload(); }, 1000);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.textContent = 'Reset Files & Lines';
        }
    })
    .catch(function(err) {
        alert('Error: ' + err);
        btn.disabled = false;
        btn.textContent = 'Reset Files & Lines';
    });
}

(function() {
    var projectId = '{{ project.id }}';
    var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';

    // Job-based lines scan handler
    function setupJobBasedLinesScan(isDirty) {
        var prefix = isDirty ? 'dirty' : 'clean';
        var form = document.getElementById(prefix + '-scan-lines-form');
        var btn = document.getElementById(prefix + '-scan-lines-btn');
        var progress = document.getElementById(prefix + '-scan-lines-progress');
        var countSpan = document.getElementById(prefix + '-scan-lines-count');
        var countDisplay = document.getElementById(prefix + '-lines-count');
        var jobType = 'scan_lines_' + isDirty;

        if (!form || !btn || btn.disabled || !window.WebSocket) return;

        // Function to observe a job via WebSocket
        function observeJob(jobId) {
            var wsUrl = protocol + '//' + window.location.host + '/job/' + jobId + '/ws';
            var ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                btn.disabled = true;
                btn.textContent = 'Scanning...';
                if (progress) progress.style.display = 'block';
            };

            ws.onmessage = function(event) {
                var data = JSON.parse(event.data);

                if (data.type === 'update') {
                    if (countSpan) countSpan.textContent = data.progress || 0;
                    if (countDisplay) countDisplay.textContent = data.progress || 0;
                    if (data.message) {
                        btn.textContent = data.message.length > 20 ? data.message.substring(0, 20) + '...' : data.message;
                    }
                } else if (data.type === 'done') {
                    if (countSpan) countSpan.textContent = data.total || 0;
                    if (countDisplay) countDisplay.textContent = data.total || 0;
                    if (data.status === 'completed') {
                        btn.textContent = 'Done!';
                        setTimeout(function() { window.location.reload(); }, 1000);
                    } else if (data.status === 'failed') {
                        alert('Error: ' + (data.error_details || data.message || 'Job failed'));
                        btn.disabled = false;
                        btn.textContent = 'Scan Lines';
                        if (progress) progress.style.display = 'none';
                    } else if (data.status === 'cancelled') {
                        btn.disabled = false;
                        btn.textContent = 'Scan Lines';
                        if (progress) progress.style.display = 'none';
                    }
                } else if (data.type === 'error') {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.textContent = 'Scan Lines';
                    if (progress) progress.style.display = 'none';
                }
            };

            ws.onerror = function() {
                // Fall back to polling if WebSocket fails
                pollJobStatus(jobId);
            };

            ws.onclose = function(event) {
                // If closed unexpectedly and job might still be running, try to reconnect
                if (!event.wasClean && btn.disabled) {
                    setTimeout(function() {
                        checkAndReconnect();
                    }, 2000);
                }
            };
        }

        // Polling fallback
        function pollJobStatus(jobId) {
            fetch('/job/' + jobId)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.status === 'running' || data.status === 'pending') {
                        if (countSpan) countSpan.textContent = data.progress || 0;
                        if (countDisplay) countDisplay.textContent = data.progress || 0;
                        setTimeout(function() { pollJobStatus(jobId); }, 1000);
                    } else if (data.status === 'completed') {
                        if (countDisplay) countDisplay.textContent = data.total || data.progress || 0;
                        btn.textContent = 'Done!';
                        setTimeout(function() { window.location.reload(); }, 1000);
                    } else {
                        btn.disabled = false;
                        btn.textContent = 'Scan Lines';
                        if (progress) progress.style.display = 'none';
                    }
                })
                .catch(function() {
                    btn.disabled = false;
                    btn.textContent = 'Scan Lines';
                    if (progress) progress.style.display = 'none';
                });
        }

        // Check for existing running job and reconnect
        function checkAndReconnect() {
            fetch('/project/' + projectId + '/job/' + jobType)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.status === 'running' || data.status === 'pending') {
                        // Job is still running, reconnect
                        if (countSpan) countSpan.textContent = data.progress || 0;
                        if (countDisplay) countDisplay.textContent = data.progress || 0;
                        observeJob(data.id);
                    }
                })
                .catch(function() {
                    // No running job found
                });
        }

        // Form submit handler - start a new job
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            btn.disabled = true;
            btn.textContent = 'Starting...';

            fetch('/project/' + projectId + '/scan/lines/start?is_dirty=' + isDirty, {
                method: 'POST'
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.textContent = 'Scan Lines';
                    return;
                }

                if (progress) progress.style.display = 'block';
                if (countSpan) countSpan.textContent = '0';

                // Connect to job observer
                observeJob(data.job_id);
            })
            .catch(function(err) {
                alert('Error starting scan: ' + err);
                btn.disabled = false;
                btn.textContent = 'Scan Lines';
            });
        });

        // On page load, check for running jobs
        checkAndReconnect();
    }

    // Legacy WebSocket handler for other scan types (files, tables, db-rows)
    function setupLegacyScanHandler(prefix, endpoint, isDirty, buttonText, itemName) {
        var form = document.getElementById(prefix + '-form');
        var btnId;
        if (prefix.indexOf('-scan-files') > -1) {
            btnId = prefix.replace('-scan-files-form', '-scan-btn');
        } else if (prefix.indexOf('-scan-tables') > -1) {
            btnId = prefix.replace('-form', '-btn');
        } else if (prefix.indexOf('-scan-db-rows') > -1) {
            btnId = prefix.replace('-form', '-btn');
        }
        var btn = document.getElementById(btnId);

        var progressId = prefix.replace('-form', '-progress').replace('-files-progress', '-progress');
        var progress = document.getElementById(progressId);
        var countSpanId = prefix.replace('-form', '-count').replace('-files-count', '-count');
        var countSpan = document.getElementById(countSpanId);

        var type = prefix.split('-')[0];
        var countId;
        if (prefix.indexOf('-files') > -1) {
            countId = type + '-file-count';
        } else if (prefix.indexOf('-tables') > -1) {
            countId = type + '-tables-count';
        } else if (prefix.indexOf('-db-rows') > -1) {
            countId = type + '-db-rows-count';
        }
        var countDisplay = document.getElementById(countId);

        if (form && btn && !btn.disabled && window.WebSocket) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                var wsUrl = protocol + '//' + window.location.host + '/project/' + projectId + '/scan/' + endpoint + '/ws?is_dirty=' + isDirty;
                var ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    btn.disabled = true;
                    btn.textContent = 'Scanning...';
                    if (progress) progress.style.display = 'block';
                    if (countSpan) countSpan.textContent = '0';
                    if (countDisplay) countDisplay.textContent = '0';
                };

                ws.onmessage = function(event) {
                    var data = JSON.parse(event.data);

                    if (data.type === 'progress') {
                        if (countSpan) countSpan.textContent = data.count;
                        if (countDisplay) countDisplay.textContent = data.count;
                    } else if (data.type === 'done') {
                        if (countSpan) countSpan.textContent = data.total;
                        if (countDisplay) countDisplay.textContent = data.total;
                        btn.textContent = 'Done!';
                        setTimeout(function() {
                            window.location.reload();
                        }, 1000);
                    } else if (data.type === 'error') {
                        alert('Error: ' + data.message);
                        btn.disabled = false;
                        btn.textContent = buttonText;
                        if (progress) progress.style.display = 'none';
                    }
                };

                ws.onerror = function() {
                    form.submit();
                };
            });
        }
    }

    // Set up job-based handlers for lines scans
    setupJobBasedLinesScan(0); // Clean
    setupJobBasedLinesScan(1); // Dirty

    // Set up legacy handlers for other scan types (files, tables, db-rows)
    setupLegacyScanHandler('clean-scan-files-form', 'files', 0, 'Scan Files', 'files');
    setupLegacyScanHandler('clean-scan-tables-form', 'tables', 0, 'Scan Tables', 'tables');
    setupLegacyScanHandler('clean-scan-db-rows-form', 'db-rows', 0, 'Scan Rows', 'rows');

    setupLegacyScanHandler('dirty-scan-files-form', 'files', 1, 'Scan Files', 'files');
    setupLegacyScanHandler('dirty-scan-tables-form', 'tables', 1, 'Scan Tables', 'tables');
    setupLegacyScanHandler('dirty-scan-db-rows-form', 'db-rows', 1, 'Scan Rows', 'rows');
})();
</script>
{% endif %}
{% endblock %}
